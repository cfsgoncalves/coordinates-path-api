version: '3'

services:
  meight:
    build: .
    ports:
      - 8080:8080
    environment:
      GIN_MODE: release
      REDIS_PASSWORD: eYVX7EwVmmxKPCDmwMtyKVge8oLd2t81
      REDIS_TTL: 900
      REDIS_DB: 0
      LOG_LEVEL: 0
      SERVER_PORT: 8080
      SERVER: localhost
      REDIS_SERVER: cache
      REDIS_PORT: 6379
      REQUEST_PATH: https://wps.hereapi.com/v8/findsequence2
      API_KEY: Xi-sfj72ReKKh6O1_r0oTz9AUVPx5j84JzMaeRj-mb8
      STARTING_POINT: FintechHouse;38.71814,-9.14552
      CALCULATION_MODE: shortest;truck;traffic:disabled
      DB_USERNAME: meight
      DB_PASSWORD: meight
      DB_PORT: 5432
      DB_NAME: meight
      DB_HOST: postgres
    depends_on:
      - postgres
      - cache
    networks:
      - localnet

  postgres:
    image: postgres:14-alpine
    ports:
      - 5432:5432
    volumes:
      - db:/var/lib/postgresql/data 
    environment:
      POSTGRES_PASSWORD: meight
      POSTGRES_USER: meight
      POSTGRES_DB: meight
    networks:
      - localnet
  
  cache:
    image: redis:6.2-alpine
    restart: always
    ports:
      - 6379:6379
    command: redis-server --save 20 1 --loglevel warning --requirepass eYVX7EwVmmxKPCDmwMtyKVge8oLd2t81
    volumes: 
      - cache:/data
    networks:
      - localnet
  
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - 22181:2181

  kafka:
    image: confluentinc/cp-kafka:latest
    depends_on:
      - zookeeper
    ports:
      - 29092:29092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

  tests:
    build:
      context: .
      dockerfile: Dockerfile.dev
    environment:
      - REDIS_SERVER="cache"
      - REDIS_PASSWORD=eYVX7EwVmmxKPCDmwMtyKVge8oLd2t81
      - REDIS_TTL=900
      - REDIS_DB=0
      - REDIS_PORT=6379
    depends_on:
      - postgres
      - cache
    networks:
      - localnet

volumes:
  db:
    driver: local
  cache:
    driver: local

networks:
  localnet:
    name: local

